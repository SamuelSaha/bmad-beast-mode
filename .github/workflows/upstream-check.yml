name: Upstream BMAD Check

on:
  schedule:
    # Run weekly on Monday at 9 AM
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Check Native BMAD Version
        id: check
        run: |
          # Check npm for latest BMAD version
          LATEST=$(npm view bmad version 2>/dev/null || echo "unknown")
          echo "Latest Native BMAD: $LATEST"
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          
          # Check GitHub releases
          RELEASES=$(curl -s https://api.github.com/repos/bmad-method/bmad/releases/latest | jq -r '.tag_name // "none"')
          echo "Latest Release: $RELEASES"
          echo "release=$RELEASES" >> $GITHUB_OUTPUT

      - name: Create Issue if New Version
        if: steps.check.outputs.latest != 'unknown'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.check.outputs.latest }}';
            const release = '${{ steps.check.outputs.release }}';
            
            // Check if issue already exists for this version
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'upstream-sync',
              state: 'open'
            });
            
            const exists = issues.data.some(i => i.title.includes(version));
            
            if (!exists && version !== 'unknown') {
              const issueBody = `## Upstream Update Detected
              
              **Native BMAD Version:** ${version}
              **Latest Release:** ${release}

              ### Action Required
              1. Review [BMAD Changelog](https://github.com/bmad-method/bmad/releases)
              2. Identify features worth integrating
              3. Update relevant agents in 'agents/' directory
              4. Close this issue when synced or intentionally skipped

              ### Priority Candidates
              - [ ] New agent patterns
              - [ ] Workflow improvements
              - [ ] Prompt engineering updates

              *Auto-generated by Upstream Check workflow*`;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”„ Upstream Check: Native BMAD ${version} Available`,
                body: issueBody,
                labels: ['upstream-sync', 'enhancement']
              });
            }
