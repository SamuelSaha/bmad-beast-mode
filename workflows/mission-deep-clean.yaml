# Beast Mode: Mission Deep Clean
# For: Heavy refactoring, legacy code modernization, technical debt paydown
# Time to Start: < 5 minutes

id: mission-deep-clean
name: "ðŸ› Mission: Deep Clean (Refactor)"
description: "Analysis â†’ Strategy â†’ Execution for legacy or messy code."
estimated_time: "2-4 hours"

trigger_conditions:
  - Legacy code needing modernization
  - High technical debt area
  - Performance bottleneck identified
  - Security vulnerability in old code
  - Code review flagged quality issues

agents:
  squad:
    - analyst
    - architect
    - dev

coordination: sequential_handoff

phases:
  - phase: The Autopsy
    agent: analyst
    command: "*analyze-code-quality file: '{target_file}' depth: 'comprehensive'"
    artifact: "docs/bmad/{slug}/01-autopsy.md"
    required: true
    tasks:
      - Identify performance bottlenecks
      - Find security risks
      - Detect code smells
      - Calculate complexity metrics
      - Document current behavior
    analysis_categories:
      - Performance: Slow algorithms, memory leaks, database N+1
      - Security: Injection points, unsafe handling, hardcoded secrets
      - Maintainability: God functions, magic numbers, poor naming
      - Modularity: Tight coupling, low cohesion
      - Testing: Low coverage, hard-to-test code
    gates:
      - All issues categorized by severity
      - Current behavior fully documented
      - No assumptions made - only evidence-based findings

  - phase: The Strategy
    agent: architect
    command: "*plan-refactor analysis: 'docs/bmad/{slug}/01-autopsy.md' preserve: 'API contract'"
    artifact: "docs/bmad/{slug}/02-refactor-plan.md"
    required: true
    tasks:
      - Propose modernization approach
      - Define design patterns to apply
      - Plan for API contract preservation
      - Estimate risk and effort
      - Define success criteria
    strategy_components:
      - Pattern Selection: Which design patterns fit?
      - Incremental Steps: How to refactor safely?
      - Testing Strategy: How to prove equivalence?
      - Rollback Plan: What if refactor causes issues?
    gates:
      - API contract preserved (no breaking changes)
      - Refactor plan is incremental (not big-bang)
      - Testing strategy defined
      - Risk assessment completed

  - phase: The Surgery
    agent: dev
    command: "*execute-refactor plan: 'docs/bmad/{slug}/02-refactor-plan.md'"
    artifact: "docs/bmad/{slug}/03-refactored-code.md"
    required: true
    tasks:
      - Rewrite code following refactor plan
      - Ensure strong typing
      - Update error handling
      - Add comprehensive documentation
      - Maintain or improve performance
    refactoring_rules:
      - Preserve Logic: Behavior must stay identical
      - Improve Readability: Reduce complexity
      - Modern Syntax: Use latest language features
      - Type Safety: Remove any/unknown types
      - Error Handling: Comprehensive and clear
      - Documentation: Explain WHY, not just WHAT
    gates:
      - All existing tests still pass
      - Complexity reduced measurably
      - No new security vulnerabilities
      - Performance maintained or improved
      - Code coverage maintained or increased

  - phase: Verification
    agent: qa
    command: "*verify-refactor original: '{target_file}' refactored: 'docs/bmad/{slug}/03-refactored-code.md'"
    artifact: "docs/bmad/{slug}/04-verification.md"
    required: true
    tasks:
      - Run full test suite
      - Benchmark performance
      - Verify edge cases
      - Check for regressions
      - Validate behavior equivalence
    gates:
      - 100% test pass rate
      - Performance benchmarks green
      - No regressions detected
      - Edge cases still handled

handoff_protocol:
  - from: analyst
    to: architect
    context: "Comprehensive diagnosis with severity categorization"
    verification: "Architect confirms understanding of issues"
  
  - from: architect
    to: dev
    context: "Refactor plan with incremental steps"
    verification: "Dev confirms plan feasibility"
  
  - from: dev
    to: qa
    context: "Refactored code with documentation"
    verification: "QA confirms testability"

output_format:
  autopsy:
    - Issue List: [Categorized by severity]
    - Metrics: [Complexity, coverage, performance]
    - Behavior Documentation: [Current functionality]
  
  strategy:
    - Design Patterns: [Which to apply]
    - Incremental Steps: [Phase-by-phase plan]
    - Risk Assessment: [What could go wrong]
  
  surgery:
    - Refactored Code: [Modernized implementation]
    - Change Log: [What changed and why]
    - Metrics Comparison: [Before/after]
  
  verification:
    - Test Results: [Pass/fail]
    - Performance Benchmarks: [Before/after]
    - Regression Report: [Any issues]

quality_gates:
  blocking:
    - Must not break API contract
    - Must maintain test pass rate
    - Must not introduce security vulnerabilities
    - Must reduce complexity
  
  warning:
    - If performance regresses >5%
    - If test coverage decreases
    - If refactor requires >1 week

stop_rules:
  - If autopsy reveals scope too large, break into smaller refactors
  - If API breaking changes needed, escalate to stakeholders
  - If tests failing, stop and debug before proceeding
  - If security-critical, add Security squad review
