# Beast Mode: Smart Refactor Protocol
# For: Code modernization, complexity reduction, maintainability improvements
# Time to Start: < 2 minutes

id: smart-refactor
name: "ðŸ”§ Smart Refactor Protocol"
description: "Intelligent refactoring that balances readability, performance, and modern patterns without breaking logic."
estimated_time: "15 minutes - 1 hour"

trigger_conditions:
  - High cyclomatic complexity (>10)
  - Code smells detected (magic numbers, deep nesting, god functions)
  - Legacy syntax (var, callback hell, pre-ES6)
  - Tech debt paydown sprint
  - Pre-code review cleanup

agents:
  primary: dev
  support:
    - analyst
    - architect

phases:
  - phase: Analyze
    agent: analyst
    command: "*analyze-code context: '{code_file}'"
    artifact: "docs/bmad/{slug}/refactor-analysis.md"
    required: true
    tasks:
      - Identify code pattern (procedural/OOP/functional)
      - Spot code smells
      - Calculate complexity metrics
      - Scan for security issues
    gates:
      - Complexity score calculated
      - Key issues identified (2-3 minimum)
      - Original behavior documented

  - phase: Strategy
    agent: architect
    command: "*define-refactor-plan source: 'docs/bmad/{slug}/refactor-analysis.md'"
    artifact: "docs/bmad/{slug}/refactor-strategy.md"
    required: true
    tasks:
      - Define modernization targets
      - Plan guard clauses for nested logic
      - Identify extraction opportunities
      - Enforce type safety improvements
    gates:
      - Refactor plan preserves all logic
      - No breaking API changes
      - Performance neutral or improved

  - phase: Execute
    agent: dev
    command: "*refactor-code plan: 'docs/bmad/{slug}/refactor-strategy.md'"
    artifact: "docs/bmad/{slug}/refactored-code.md"
    required: true
    rules:
      - Guard Clauses: Replace nested if/else with early returns
      - Extract Methods: Break large logic into semantic helpers
      - Modernize: Use latest language features (Optional Chaining, Nullish Coalescing, Async/Await)
      - Type Safety: Remove 'any', enforce strict types (TypeScript/typed languages)
      - Preserve Logic: Functionality must remain identical
    gates:
      - All tests pass (no regressions)
      - Complexity reduced by >20%
      - No new security vulnerabilities
      - Code follows project style guide

  - phase: Verify
    agent: qa
    command: "*verify-refactor diff: 'docs/bmad/{slug}/refactored-code.md'"
    artifact: "docs/bmad/{slug}/refactor-verification.md"
    required: true
    gates:
      - Behavior equivalence confirmed
      - Performance benchmarks meet targets
      - Edge cases still handled

output_format:
  analysis:
    - Original Complexity: [High/Med/Low]
    - Cyclomatic Complexity Score: [Number]
    - Key Issues: [List 2-3 main problems]
  
  solution:
    - Refactored code block
    - Change log with reasoning
    - Before/After complexity comparison
    - Test coverage report

quality_gates:
  blocking:
    - Zero failing tests
    - No security vulnerabilities introduced
    - Complexity reduced
  
  warning:
    - Performance regression >5%
    - Test coverage decreased

stop_rules:
  - If logic cannot be preserved exactly, flag for manual review
  - If refactor requires API changes, escalate to Architecture Review
  - If security-sensitive code, add Security squad
