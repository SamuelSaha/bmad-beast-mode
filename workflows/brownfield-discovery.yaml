# Beast Mode: Brownfield Discovery Workflow
# For: Mapping existing codebases before starting work
# Time to Start: < 15 minutes

id: brownfield-discovery
name: "ðŸ—ºï¸ Brownfield Discovery Flow"
description: |
  Map an existing codebase before making changes.
  Document architecture, tech debt, and patterns before you build.
  Essential for legacy code, inherited projects, or unfamiliar modules.
estimated_time: "1-2 hours"

trigger_conditions:
  - Working on legacy code
  - Inherited project
  - Unfamiliar codebase
  - Before major refactor
  - New team member onboarding

trigger_keywords:
  - brownfield
  - legacy
  - existing
  - inherited
  - scan
  - discover
  - map

phases:
  # === PHASE 1: STRUCTURE SCAN ===
  - phase: Structure Scan
    description: "Map the high-level directory structure"
    agent: architect
    command: "*scan-structure"
    instruction: |
      Scan the project root and map:
      
      1. **Directory Structure**
         - Main source folders
         - Test locations
         - Config files
         - Documentation
      
      2. **Entry Points**
         - Main application entry
         - API routes/handlers
         - CLI commands
      
      3. **Technology Stack**
         - Language/Runtime
         - Framework
         - Build tools
         - Package manager
      
      Output: File tree + technology summary
    artifact: "docs/bmad/discovery/01-structure.md"
    required: true

  # === PHASE 2: ARCHITECTURE MAP ===
  - phase: Architecture Map
    description: "Map the system architecture"
    agent: architect
    command: "*map-architecture"
    instruction: |
      Create an architecture diagram (Mermaid):
      
      1. **Component Diagram**
         - Major modules/packages
         - Their responsibilities
         - Dependencies between them
      
      2. **Data Flow**
         - How data enters the system
         - How it's transformed
         - Where it's stored
      
      3. **External Dependencies**
         - APIs consumed
         - Databases
         - Third-party services
      
      ```mermaid
      graph TD
        A[User] --> B[Frontend]
        B --> C[API]
        C --> D[Database]
      ```
    artifact: "docs/bmad/discovery/02-architecture.md"
    required: true

  # === PHASE 3: STATE MANAGEMENT ===
  - phase: State Analysis
    description: "Map state management patterns"
    agent: architect
    command: "*analyze-state"
    instruction: |
      Identify:
      
      1. **State Sources**
         - Client state (React state, Redux, Zustand, etc.)
         - Server state (React Query, SWR, etc.)
         - URL state (query params, path)
         - Form state
      
      2. **State Patterns**
         - How is global state managed?
         - How do components share state?
         - Are there known issues?
      
      3. **Data Fetching**
         - How are API calls made?
         - Caching strategy
         - Error handling
    artifact: "docs/bmad/discovery/03-state.md"
    required: true

  # === PHASE 4: PATTERNS INVENTORY ===
  - phase: Patterns Inventory
    description: "Document existing code patterns"
    agent: reviewer
    command: "*inventory-patterns"
    instruction: |
      Document the codebase conventions:
      
      1. **Naming Conventions**
         - Files: kebab-case, PascalCase, etc.
         - Functions: camelCase, snake_case, etc.
         - Components: PascalCase
      
      2. **Code Organization**
         - How are features structured?
         - Barrel exports (index.ts)?
         - Colocation patterns
      
      3. **Common Patterns**
         - Error handling
         - Authentication flow
         - API client usage
         - Component composition
      
      4. **Testing Patterns**
         - Test file locations
         - Naming conventions
         - Mock patterns
    artifact: "docs/bmad/discovery/04-patterns.md"
    required: true

  # === PHASE 5: TECH DEBT AUDIT ===
  - phase: Tech Debt Audit
    description: "Identify technical debt and anti-patterns"
    agent: refactor
    command: "*audit-debt"
    instruction: |
      Identify and categorize tech debt:
      
      **Code Smells:**
      - [ ] Long files (> 300 lines)
      - [ ] God components/classes
      - [ ] Deep nesting
      - [ ] Copy-paste code
      - [ ] Magic numbers/strings
      
      **Architectural Debt:**
      - [ ] Circular dependencies
      - [ ] Inappropriate coupling
      - [ ] Missing abstractions
      - [ ] Inconsistent patterns
      
      **Dependency Debt:**
      - [ ] Outdated packages
      - [ ] Deprecated APIs
      - [ ] Unused dependencies
      - [ ] Security vulnerabilities
      
      **Documentation Debt:**
      - [ ] Missing README
      - [ ] Outdated comments
      - [ ] No API docs
      
      Prioritize by: Impact Ã— Effort to fix
    artifact: "docs/bmad/discovery/05-tech-debt.md"
    required: true

  # === PHASE 6: SECURITY SCAN ===
  - phase: Security Scan
    description: "Identify security concerns"
    agent: sec-ops
    command: "*scan-security"
    instruction: |
      Quick security review:
      
      1. **Secrets**
         - Any hardcoded secrets?
         - Env vars properly used?
         - Config files in .gitignore?
      
      2. **Authentication**
         - How is auth implemented?
         - Session management?
         - Known vulnerabilities?
      
      3. **Input Handling**
         - Input validation present?
         - SQL injection risks?
         - XSS vulnerabilities?
      
      4. **Dependencies**
         - Run npm audit / pip audit
         - Check for critical CVEs
    artifact: "docs/bmad/discovery/06-security.md"
    required: true

  # === PHASE 7: IMPROVEMENT ROADMAP ===
  - phase: Improvement Roadmap
    description: "Create actionable improvement plan"
    agent: architect
    command: "*plan-improvements"
    instruction: |
      Based on all findings, create a prioritized roadmap:
      
      ## Quick Wins (< 1 day each)
      - [ ] Fix X
      - [ ] Update Y
      
      ## Short Term (Sprint 1-2)
      - [ ] Refactor Z
      - [ ] Add tests for W
      
      ## Medium Term (Quarter)
      - [ ] Migrate to new pattern
      - [ ] Address security findings
      
      ## Long Term (Backlog)
      - [ ] Major architectural changes
      
      Include effort estimates and dependencies.
    artifact: "docs/bmad/discovery/07-roadmap.md"
    required: true
    gates:
      - All phases complete
      - Actionable items identified
      - Priorities assigned

output_sequence:
  - "docs/bmad/discovery/01-structure.md"
  - "docs/bmad/discovery/02-architecture.md"
  - "docs/bmad/discovery/03-state.md"
  - "docs/bmad/discovery/04-patterns.md"
  - "docs/bmad/discovery/05-tech-debt.md"
  - "docs/bmad/discovery/06-security.md"
  - "docs/bmad/discovery/07-roadmap.md"

next_steps:
  - "Use findings as context for future work"
  - "Reference patterns when implementing"
  - "Address quick wins immediately"
  - "Plan tech debt sprints based on roadmap"
